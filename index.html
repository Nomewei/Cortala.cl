<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Córtala.cl - Libérate del SPAM en sólo 3 pasos.</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hero-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .plan-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; display: flex; flex-direction: column; }
        .plan-card:hover { transform: translateY(-5px); }
        .plan-card.selected { border-color: #2563eb; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: translateY(-5px) scale(1.02); }
        .plan-card-content { flex-grow: 1; }
        .progress-bar-container { position: sticky; top: 80px; z-index: 30; background-color: rgba(248, 250, 252, 0.8); backdrop-filter: blur(8px); padding-top: 1rem; padding-bottom: 1rem; transition: opacity 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .recommended-badge { position: absolute; top: -15px; right: 20px; background-color: #2563eb; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; transform: rotate(10deg); }
        .savings-badge { background-color: #dbeafe; color: #1e40af; font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; display: inline-block; margin-top: 0.5rem; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scale-in { animation: scaleIn 0.3s ease-out forwards; }
        #mobile-menu-container { position: fixed; top: 0; right: 0; bottom: 0; width: 75%; max-width: 300px; z-index: 50; pointer-events: none; transform: translateX(100%); transition: transform 0.3s ease-in-out; }
        #mobile-menu { position: absolute; top: 0; right: 0; bottom: 0; width: 100%; background-color: white; pointer-events: auto; box-shadow: -10px 0 25px rgba(0,0,0,0.1); display: flex; flex-direction: column; padding: 1.5rem; padding-top: 4rem; }
        #mobile-menu-container.open { transform: translateX(0); }
    </style>
</head>
<body class="text-gray-800">

    <div id="referral-banner" class="hidden bg-green-100 border-b-2 border-green-200 text-green-800 text-center p-3 font-semibold">
        ¡Gracias a tu amigo, tienes 1 slot gratis en tu primera compra!
    </div>

    <header id="main-header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-gray-200 h-20 flex items-center">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="/" id="logo-link" class="flex items-center gap-2 text-2xl font-bold text-blue-700">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" fill="#3b82f6"/><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.23-3.75-6.58-6.58l1.97-1.57a.977.977 0 00.24-1.01c-.36-1.11-.56-2.3-.56-3.53A1 1 0 007.62 4H4a1 1 0 00-1 1 17 17 0 0017 17 1 1 0 001-1v-3.62a1 1 0 00-1-1z" fill="white" transform="scale(0.75) translate(4, 4)"/></svg>
                <div class="flex items-baseline"><span class="text-2xl font-bold text-[#1d4ed8]">órtala</span><span class="text-2xl font-bold text-[#3b82f6]">.cl</span></div>
            </a>
            <nav class="hidden md:flex items-center space-x-6 text-gray-600">
                 <a href="#plans-section" class="hover:text-blue-600 transition">Planes</a>
                 <a href="#" onclick="showModal('modal-faq')" class="hover:text-blue-600 transition">FAQ's</a>
                 <a href="#" onclick="showModal('modal-terminos')" class="hover:text-blue-600 transition">Términos</a>
                 <a href="#" onclick="showModal('modal-incumplimiento')" class="hover:text-blue-600 transition">Avisar Incumplimiento</a>
                 <a href="#" onclick="showModal('modal-contacto')" class="hover:text-blue-600 transition">Ayuda</a>
            </nav>
            <div class="md:hidden"><button id="menu-button" class="text-gray-700 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div>
        </div>
    </header>
    
    <div id="mobile-menu-container" class="">
        <div id="mobile-menu">
            <button id="close-menu-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
            <a href="#plans-section" id="mobile-nav-plans-link" class="block py-3 text-lg text-gray-700 hover:text-blue-600">Planes</a>
            <a href="#" onclick="showModal('modal-faq'); closeMobileMenu();" class="block py-3 text-lg text-gray-700 hover:text-blue-600">FAQ's</a>
            <a href="#" onclick="showModal('modal-terminos'); closeMobileMenu();" class="block py-3 text-lg text-gray-700 hover:text-blue-600">Términos</a>
            <a href="#" onclick="showModal('modal-incumplimiento'); closeMobileMenu();" class="block py-3 text-lg text-gray-700 hover:text-blue-600">Avisar Incumplimiento</a>
            <a href="#" onclick="showModal('modal-contacto'); closeMobileMenu();" class="block py-3 text-lg text-gray-700 hover:text-blue-600">Ayuda</a>
        </div>
    </div>

    <main id="main-content">
        <section id="hero-section" class="hero-gradient text-white">
            <div class="container mx-auto px-6 text-center py-20 md:py-28">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold leading-tight mb-4">Libérate del SPAM en sólo 3 pasos</h1>
                <p class="text-lg md:text-xl text-blue-200 max-w-3xl mx-auto mb-8">Gestionamos el ingreso de tus teléfonos y correos en la lista "No Molestar" del SERNAC. Rápido, fácil y en un Pago Único.</p>
                <a href="#plans-section" id="start-now-btn" class="bg-white text-blue-700 font-bold py-3 px-8 rounded-full text-lg hover:bg-blue-100 transition transform hover:scale-105 inline-block">Comenzar Ahora</a>
                <div class="mt-12">
                    <p class="text-sm uppercase tracking-widest text-blue-300">Protecciones en tiempo real</p>
                    <p id="client-counter" class="text-4xl font-bold">1,470</p>
                </div>
            </div>
        </section>

        <div id="checkout-funnel" class="container mx-auto px-6">
            <div id="progress-bar-container" class="progress-bar-container opacity-0 -translate-y-4"><div class="bg-gray-200 rounded-full h-2.5 w-full"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>

            <section id="plans-section" class="py-16 lg:py-24">
                <h2 class="text-3xl font-bold text-center mb-2">Paso 1: Elige tu plan</h2>
                <p class="text-center text-gray-600 mb-12">Un "slot" te permite proteger un Teléfono o un Correo electrónico.¡Tú eliges!</p>
                <div id="plans-container" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    <div class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-gray-200 text-center" data-plan='{"name": "Personal", "slots": 1, "price": 500}'>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Personal</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">1</span> <span class="text-lg font-medium">slot</span></p><p class="text-gray-500 mb-4">Eliges 1 teléfono o correo.</p></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$500</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                    <div id="recommended-plan" class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-blue-600 text-center relative selected" data-plan='{"name": "Dúo", "slots": 2, "price": 14990}'>
                        <div class="recommended-badge">Recomendado</div>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Dúo</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">2</span> <span class="text-lg font-medium">slots</span></p><p class="text-gray-500 mb-4">Eliges entre 2 teléfonos y correos.</p><div class="savings-badge">Ahorras 17%</div></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$14.990</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                    <div class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-gray-200 text-center" data-plan='{"name": "Familiar", "slots": 5, "price": 28990}'>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Familiar</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">5</span> <span class="text-lg font-medium">slots</span></p><p class="text-gray-500 mb-4">Eliges entre 5 teléfonos y correos.</p><div class="savings-badge">Ahorras 35%</div></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$28.990</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                </div>
            </section>
            
            <section id="contacts-section" class="py-24 hidden">
                <h2 class="text-3xl font-bold text-center mb-4">Paso 2: Ingresa los contactos a proteger</h2>
                <p id="contacts-subtitle" class="text-center text-gray-600 mb-12"></p>
                <div class="max-w-xl mx-auto contacts-container-gradient p-8 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-6"><h3 class="font-semibold text-lg text-gray-800">Añade aqui a tus Contactos</h3><p id="slot-counter" class="font-bold text-blue-600 bg-blue-100 px-3 py-1 rounded-full text-sm">0 / 2</p></div>
                    <div class="relative mb-1">
                        <div class="flex items-center border border-gray-300 rounded-lg focus-within:ring-2 focus-within:ring-blue-500">
                           <span class="px-3 text-gray-500 bg-gray-100 h-full flex items-center rounded-l-lg border-r border-gray-300">+56</span>
                           <input type="text" id="contact-input" placeholder="9 8765 4321 o correo@ejemplo.com" class="w-full px-4 py-3 border-0 rounded-r-lg focus:outline-none">
                        </div>
                        <button id="add-contact-btn" class="absolute right-2 top-1/2 -translate-y-1/2 bg-blue-600 text-white font-bold w-10 h-10 flex items-center justify-center rounded-lg hover:bg-blue-700 transition disabled:bg-gray-300" disabled><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg></button>
                    </div>
                    <p id="contact-error" class="text-red-500 text-sm h-5 mb-2"></p>
                    <div id="contact-list" class="space-y-2 mb-6 min-h-[50px]"></div>
                    <button id="continue-to-payment-btn" class="w-full bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed">Continuar al Pago</button>
                    <div class="text-center mt-4">
                        <button id="back-to-plans-btn" class="text-sm text-gray-500 hover:text-gray-800 transition">&larr; Volver a Planes</button>
                    </div>
                </div>
            </section>

            <section id="payment-section" class="py-24 hidden">
                <h2 class="text-3xl font-bold text-center mb-12">Paso 3: Un último paso para tu tranquilidad</h2>
                <div class="grid md:grid-cols-2 gap-12 max-w-4xl mx-auto">
                    <div class="bg-white p-8 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">Resumen de tu compra</h3>
                        <div class="space-y-2 text-gray-600">
                            <div class="flex justify-between"><span>Plan:</span><span id="summary-plan-name" class="font-semibold"></span></div>
                            <div class="flex justify-between"><span>Contactos a proteger:</span><span id="summary-contact-count" class="font-semibold"></span></div>
                            <hr class="my-4">
                            <div class="flex justify-between text-lg font-bold"><span>TOTAL:</span><span id="summary-total-price"></span></div>
                        </div>
                        <div class="mt-6 bg-slate-50 p-4 rounded-lg text-center">
                            <h4 class="font-semibold text-gray-700">Garantía de Gestión</h4>
                            <p class="text-sm text-gray-600 mt-1">Nos aseguramos de que tus datos queden correctamente inscritos en la plataforma oficial del SERNAC.</p>
                        </div>
                    </div>
            
                    <div class="bg-white p-8 rounded-lg shadow-md flex flex-col justify-between">
                        <div>
                            <div id="payer-form-container">
                                <h3 class="text-xl font-bold mb-4">Datos del Comprador</h3>
                                <p class="text-gray-600 mb-6 text-sm">Esta información es para mejorar la seguridad de tu pago y no será compartida.</p>
                                <div class="space-y-4">
                                    <div>
                                        <label for="payer-firstname" class="block text-sm font-medium text-gray-700">Nombre</label>
                                        <input type="text" id="payer-firstname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div>
                                        <label for="payer-lastname" class="block text-sm font-medium text-gray-700">Apellido</label>
                                        <input type="text" id="payer-lastname" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    </div>
                                    <div class="pt-2">
                                        <label for="terms-checkbox" class="flex items-start">
                                            <input type="checkbox" id="terms-checkbox" class="h-5 w-5 mt-0.5 rounded border-gray-300 text-blue-600 focus:ring-blue-500 focus:ring-offset-0">
                                            <span class="ml-3 text-sm text-gray-600">
                                                Acepto los <a href="#" onclick="showModal('modal-terminos'); return false;" class="text-blue-600 hover:underline font-semibold">Términos y Condiciones</a> y autorizo el uso de mis datos para la gestión en SERNAC.
                                            </span>
                                        </label>
                                    </div>
                                </div>
                                <button id="confirm-and-pay-btn" class="w-full mt-8 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center gap-3" disabled>
                                    <span>Pagar y Proteger</span>
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
                                </button>
                                <p id="payment-error" class="text-red-500 text-sm text-center mt-4 h-5"></p>
                            </div>
                        </div>
                        
                        <div class="text-center mt-4">
                            <button id="back-to-contacts-btn" class="text-sm text-gray-500 hover:text-gray-800 transition">&larr; Volver a Contactos</button>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </main>
    
    <div id="modal-success" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full relative animate-scale-in text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h3 class="text-2xl font-bold mb-2">¡Listo! Tu solicitud está en proceso.</h3>
            <p class="text-gray-600 mb-6">Recibirás un email de confirmación con los detalles y próximos pasos en breve.</p>
            <button onclick="closeModal('modal-success')" class="mt-6 text-sm text-gray-600 hover:text-gray-900">Cerrar</button>
        </div>
    </div>

    <!-- El resto de los modales y el HTML se mantienen igual -->
    <div id="modal-faq" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"><!-- ... --></div>
    <div id="modal-incumplimiento" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"><!-- ... --></div>
    <div id="modal-terminos" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"><!-- ... --></div>
    <div id="modal-contacto" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"><!-- ... --></div>
    <div id="modal-confirm-continue" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4"><!-- ... --></div>

    <script>
    // ✅ IA-UPDATE: Funciones globales para modales y menú móvil.
    // Se definen aquí para ser accesibles por los atributos onclick del HTML.
    function showModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) {
            if (modalId === 'modal-incumplimiento') {
                document.getElementById('incumplimiento-content').classList.remove('hidden');
                document.getElementById('incumplimiento-success').classList.add('hidden');
                document.getElementById('incumplimiento-form').reset();
            }
            modal.classList.replace('hidden', 'flex');
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (modal) modal.classList.replace('flex', 'hidden');
        if (modalId === 'modal-success') {
            location.href = '/';
        }
    }
    
    function closeMobileMenu() {
        document.getElementById('mobile-menu-container').classList.remove('open');
    }

    document.addEventListener('DOMContentLoaded', function() {
        // --- ESTADO GLOBAL ---
        let selectedPlan = JSON.parse(document.getElementById('recommended-plan').dataset.plan);
        let contacts = [];
        let currentStep = 0;
        let referralCode = null;

        // --- SELECTORES COMPLETOS ---
        const mainContent = document.getElementById('main-content');
        const heroSection = document.getElementById('hero-section');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const plansSection = document.getElementById('plans-section');
        const contactsSection = document.getElementById('contacts-section');
        const paymentSection = document.getElementById('payment-section');
        const plansContainer = document.getElementById('plans-container');
        const slotCounter = document.getElementById('slot-counter');
        const contactsSubtitle = document.getElementById('contacts-subtitle');
        const contactInput = document.getElementById('contact-input');
        const addContactBtn = document.getElementById('add-contact-btn');
        const contactList = document.getElementById('contact-list');
        const continueToPaymentBtn = document.getElementById('continue-to-payment-btn');
        const backToPlansBtn = document.getElementById('back-to-plans-btn');
        const backToContactsBtn = document.getElementById('back-to-contacts-btn');
        const summaryPlanName = document.getElementById('summary-plan-name');
        const summaryContactCount = document.getElementById('summary-contact-count');
        const summaryTotalPrice = document.getElementById('summary-total-price');
        const logoLink = document.getElementById('logo-link');
        const allPlanLinks = document.querySelectorAll('a[href="#plans-section"]');
        const payerFirstname = document.getElementById('payer-firstname');
        const payerLastname = document.getElementById('payer-lastname');
        const termsCheckbox = document.getElementById('terms-checkbox');
        const confirmAndPayBtn = document.getElementById('confirm-and-pay-btn');
        const paymentError = document.getElementById('payment-error');
        const menuButton = document.getElementById('menu-button');
        const closeMenuButton = document.getElementById('close-menu-btn');
        const mobileMenuContainer = document.getElementById('mobile-menu-container');
        const startNowBtn = document.getElementById('start-now-btn');

        // --- LÓGICA DE INICIO ---
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        const paymentStatus = urlParams.get('status');

        if (refParam) {
            referralCode = refParam;
            document.getElementById('referral-banner').classList.remove('hidden');
            document.querySelectorAll('.plan-card').forEach(card => {
                const planData = JSON.parse(card.dataset.plan);
                const newSlots = planData.slots + 1;
                card.querySelector('.plan-slots').innerHTML = `${planData.slots} + <span class="text-green-500">1</span>`;
                card.dataset.plan = JSON.stringify({...planData, slots: newSlots});
            });
            selectedPlan = JSON.parse(document.getElementById('recommended-plan').dataset.plan);
        }

        if (paymentStatus === 'success') {
            showModal('modal-success');
            window.history.replaceState({}, document.title, "/");
        }

        // --- FUNCIÓN DE PAGO ---
        async function createCheckoutPreference(firstName, lastName) {
            confirmAndPayBtn.firstElementChild.textContent = 'Procesando...';
            confirmAndPayBtn.disabled = true;

            try {
                const response = await fetch("/create_preference", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        title: `${selectedPlan.name} (${selectedPlan.slots} slots)`,
                        price: selectedPlan.price,
                        payer_firstname: firstName,
                        payer_lastname: lastName,
                        contacts_to_protect: contacts,
                        referral_code: referralCode
                    }),
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Error del servidor');
                const preference = await response.json();
                if (preference.init_point) {
                    window.location.href = preference.init_point;
                } else {
                    throw new Error('No se recibió la URL de pago');
                }
            } catch (error) {
                console.error("Error al crear la preferencia de pago:", error);
                paymentError.textContent = 'Hubo un error. Por favor, intenta de nuevo.';
                confirmAndPayBtn.disabled = false;
                confirmAndPayBtn.firstElementChild.textContent = 'Pagar y Proteger';
            }
        }
        
        // --- MANEJO DEL FUNNEL ---
        function showStep(stepNumber) {
            currentStep = stepNumber;
            if (stepNumber > 0) {
                progressBarContainer.classList.remove('opacity-0', '-translate-y-4');
            } else {
                progressBarContainer.classList.add('opacity-0', '-translate-y-4');
            }
            if (stepNumber >= 1) { 
                heroSection.classList.add('hidden');
            } else {
                heroSection.classList.remove('hidden');
            }
            [plansSection, contactsSection, paymentSection].forEach(s => s.classList.add('hidden'));
            
            let sectionToShow;
            if (stepNumber === 1) {
                sectionToShow = plansSection;
                updateProgressBar(33);
            } else if (stepNumber === 2) {
                sectionToShow = contactsSection;
                updateProgressBar(66);
                updateContactUI();
            } else if (stepNumber === 3) {
                sectionToShow = paymentSection;
                updateProgressBar(100);
                updateSummary();
            }
            if(sectionToShow){
                sectionToShow.classList.remove('hidden');
                sectionToShow.classList.add('fade-in');
                sectionToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        function updateProgressBar(percentage) { progressBar.style.width = `${percentage}%`; }

        // --- EVENT LISTENERS ---
        startNowBtn.addEventListener('click', e => { e.preventDefault(); showStep(1); });
        allPlanLinks.forEach(anchor => anchor.addEventListener('click', e => { e.preventDefault(); showStep(1); }));
        logoLink.addEventListener('click', e => { e.preventDefault(); if(currentStep > 0) { showStep(0); window.scrollTo({ top: 0, behavior: 'smooth' }); } else { location.reload(); } });
        plansContainer.addEventListener('click', e => {
            const card = e.target.closest('.plan-card');
            if (!card) return;
            selectedPlan = JSON.parse(card.dataset.plan);
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected', 'border-blue-600'));
            card.classList.add('selected', 'border-blue-600');
            setTimeout(() => showStep(2), 200);
        });
        contactInput.addEventListener('input', () => { addContactBtn.disabled = contactInput.value.trim() === '' || contacts.length >= selectedPlan.slots; });
        addContactBtn.addEventListener('click', () => {
            if (contactInput.value.trim() && contacts.length < selectedPlan.slots) {
                contacts.push(contactInput.value.trim());
                contactInput.value = '';
                renderContacts();
            }
        });
        contactList.addEventListener('click', e => {
            if (e.target.closest('.delete-contact-btn')) {
                contacts = contacts.filter(c => c !== e.target.closest('.delete-contact-btn').dataset.contact);
                renderContacts();
            }
        });
        continueToPaymentBtn.addEventListener('click', () => { if (contacts.length > 0) showStep(3); });
        backToPlansBtn.addEventListener('click', () => showStep(1));
        backToContactsBtn.addEventListener('click', () => showStep(2));

        function validatePayerForm() {
            confirmAndPayBtn.disabled = !(payerFirstname.value.trim() && payerLastname.value.trim() && termsCheckbox.checked);
        }
        payerFirstname.addEventListener('input', validatePayerForm);
        payerLastname.addEventListener('input', validatePayerForm);
        termsCheckbox.addEventListener('change', validatePayerForm);
        confirmAndPayBtn.addEventListener('click', () => {
            createCheckoutPreference(payerFirstname.value.trim(), payerLastname.value.trim());
        });

        // --- RENDERIZADO Y UI ---
        function updateContactUI() {
            slotCounter.textContent = `${contacts.length} / ${selectedPlan.slots}`;
            contactsSubtitle.textContent = `Tienes ${selectedPlan.slots} slots para elegir entre teléfonos y correos.`;
            contactInput.disabled = contacts.length >= selectedPlan.slots;
            addContactBtn.disabled = contactInput.value.trim() === '' || contacts.length >= selectedPlan.slots;
            continueToPaymentBtn.disabled = contacts.length === 0;
        }
        function renderContacts() {
            contactList.innerHTML = '';
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/60 p-3 rounded-lg animate-scale-in';
                item.innerHTML = `<span class="text-gray-800 font-medium">${contact}</span><button data-contact="${contact}" class="delete-contact-btn text-red-500 hover:text-red-700 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                contactList.appendChild(item);
            });
            updateContactUI();
        }
        function updateSummary() {
            summaryPlanName.textContent = selectedPlan.name;
            summaryContactCount.textContent = contacts.length;
            summaryTotalPrice.textContent = `$${selectedPlan.price.toLocaleString('es-CL')}`;
        }
        
        // --- MODALES Y MENÚ ---
        menuButton.addEventListener('click', () => { mobileMenuContainer.classList.add('open'); });
        closeMenuButton.addEventListener('click', closeMobileMenu);
    });
    </script>
</body>
</html>
