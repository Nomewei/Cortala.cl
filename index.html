<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Córtala.cl - Libérate del SPAM en sólo 3 pasos.</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .hero-gradient { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
        .plan-card { transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; display: flex; flex-direction: column; }
        .plan-card:hover { transform: translateY(-5px); }
        .plan-card.selected { border-color: #2563eb; box-shadow: 0 0 15px rgba(59, 130, 246, 0.5); transform: translateY(-5px) scale(1.02); }
        .plan-card-content { flex-grow: 1; }
        .progress-bar-container { position: sticky; top: 80px; z-index: 30; background-color: rgba(248, 250, 252, 0.8); backdrop-filter: blur(8px); padding-top: 1rem; padding-bottom: 1rem; transition: opacity 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.6s ease-out forwards; }
        .recommended-badge { position: absolute; top: -15px; right: 20px; background-color: #2563eb; color: white; padding: 4px 12px; border-radius: 9999px; font-size: 0.8rem; font-weight: 600; transform: rotate(10deg); }
        .savings-badge { background-color: #dbeafe; color: #1e40af; font-size: 0.75rem; font-weight: 600; padding: 2px 8px; border-radius: 9999px; display: inline-block; margin-top: 0.5rem; }
        @keyframes scaleIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .animate-scale-in { animation: scaleIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="text-gray-800">

    <div id="referral-banner" class="hidden bg-green-100 border-b-2 border-green-200 text-green-800 text-center p-3 font-semibold">
        ¡Gracias a tu amigo, tienes 1 slot gratis en tu primera compra!
    </div>

    <header id="main-header" class="bg-white/80 backdrop-blur-lg sticky top-0 z-40 border-b border-gray-200 h-20 flex items-center">
        <div class="container mx-auto px-6 flex justify-between items-center">
            <a href="/" id="logo-link" class="flex items-center gap-2 text-2xl font-bold text-blue-700">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="11" fill="#3b82f6"/><path d="M20.01 15.38c-1.23 0-2.42-.2-3.53-.56a.977.977 0 00-1.01.24l-1.57 1.97c-2.83-1.35-5.23-3.75-6.58-6.58l1.97-1.57a.977.977 0 00.24-1.01c-.36-1.11-.56-2.3-.56-3.53A1 1 0 007.62 4H4a1 1 0 00-1 1 17 17 0 0017 17 1 1 0 001-1v-3.62a1 1 0 00-1-1z" fill="white" transform="scale(0.75) translate(4, 4)"/></svg>
                <div class="flex items-baseline"><span class="text-2xl font-bold text-[#1d4ed8]">órtala</span><span class="text-2xl font-bold text-[#3b82f6]">.cl</span></div>
            </a>
            <nav class="hidden md:flex items-center space-x-6 text-gray-600">
                 <a href="#plans-section" class="hover:text-blue-600 transition">Planes</a>
                 <a href="#" onclick="showModal('modal-faq')" class="hover:text-blue-600 transition">FAQ's</a>
                 <a href="#" onclick="showModal('modal-incumplimiento')" class="hover:text-blue-600 transition">Avisar Incumplimiento</a>
            </nav>
            <div class="md:hidden"><button id="menu-button" class="text-gray-700 focus:outline-none"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div>
        </div>
    </header>
    
    <main id="main-content">
        <section id="hero-section" class="hero-gradient text-white">
            <div class="container mx-auto px-6 text-center py-20 md:py-28">
                <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold leading-tight mb-4">Libérate del SPAM en sólo 3 pasos</h1>
                <p class="text-lg md:text-xl text-blue-200 max-w-3xl mx-auto mb-8">Gestionamos el ingreso de tus teléfonos y correos en la lista "No Molestar" del SERNAC. Rápido, fácil y en un Pago Único.</p>
                <a href="#plans-section" id="start-now-btn" class="bg-white text-blue-700 font-bold py-3 px-8 rounded-full text-lg hover:bg-blue-100 transition transform hover:scale-105 inline-block">Comenzar Ahora</a>
            </div>
        </section>

        <div id="checkout-funnel" class="container mx-auto px-6">
            <div id="progress-bar-container" class="progress-bar-container opacity-0 -translate-y-4"><div class="bg-gray-200 rounded-full h-2.5 w-full"><div id="progress-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-500" style="width: 0%"></div></div></div>

            <section id="plans-section" class="py-16 lg:py-24">
                <h2 class="text-3xl font-bold text-center mb-2">Paso 1: Elige tu plan</h2>
                <p class="text-center text-gray-600 mb-12">Un "slot" te permite proteger un Teléfono o un Correo electrónico.¡Tú eliges!</p>
                <div id="plans-container" class="grid md:grid-cols-3 gap-8 max-w-5xl mx-auto">
                    <div class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-gray-200 text-center" data-plan='{"name": "Personal", "slots": 1, "price": 500}'>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Personal</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">1</span> <span class="text-lg font-medium">slot</span></p><p class="text-gray-500 mb-4">Eliges 1 teléfono o correo.</p></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$500</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                    <div id="recommended-plan" class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-blue-600 text-center relative selected" data-plan='{"name": "Dúo", "slots": 2, "price": 14990}'>
                        <div class="recommended-badge">Recomendado</div>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Dúo</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">2</span> <span class="text-lg font-medium">slots</span></p><p class="text-gray-500 mb-4">Eliges entre 2 teléfonos y correos.</p><div class="savings-badge">Ahorras 17%</div></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$14.990</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                    <div class="plan-card h-full cursor-pointer bg-white p-8 rounded-xl border-2 border-gray-200 text-center" data-plan='{"name": "Familiar", "slots": 5, "price": 28990}'>
                        <div class="plan-card-content"><h3 class="text-2xl font-bold mb-2">Familiar</h3><p class="text-5xl font-extrabold mb-4"><span class="plan-slots">5</span> <span class="text-lg font-medium">slots</span></p><p class="text-gray-500 mb-4">Eliges entre 5 teléfonos y correos.</p><div class="savings-badge">Ahorras 35%</div></div>
                        <p class="text-2xl font-bold text-blue-600 mt-4 mb-2">$28.990</p><button class="w-full mt-2 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-blue-700 transition">Elegir Plan</button>
                    </div>
                </div>
            </section>
            
            <section id="contacts-section" class="py-24 hidden"><!-- ... --></section>
            <section id="payment-section" class="py-24 hidden"><!-- ... --></section>
        </div>
    </main>
    
    <div id="modal-success" class="fixed inset-0 bg-black bg-opacity-60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-lg shadow-2xl p-8 max-w-lg w-full relative animate-scale-in text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4"><svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg></div>
            <h3 class="text-2xl font-bold mb-2">¡Listo! Tu solicitud está en proceso.</h3>
            <p class="text-gray-600 mb-6">Recibirás un email de confirmación con los detalles y próximos pasos en breve.</p>
            <button onclick="closeModal('modal-success')" class="mt-6 text-sm text-gray-600 hover:text-gray-900">Cerrar</button>
        </div>
    </div>
    
    <!-- El resto de los modales y el HTML se mantienen igual -->

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ESTADO GLOBAL ---
        let selectedPlan = JSON.parse(document.getElementById('recommended-plan').dataset.plan);
        let contacts = [];
        let currentStep = 0;
        let referralCode = null;

        // --- SELECTORES (versión abreviada para claridad) ---
        const confirmAndPayBtn = document.getElementById('confirm-and-pay-btn');
        const plansContainer = document.getElementById('plans-container');

        // --- LÓGICA DE INICIO ---
        const urlParams = new URLSearchParams(window.location.search);
        const refParam = urlParams.get('ref');
        const paymentStatus = urlParams.get('status');

        if (refParam) {
            referralCode = refParam;
            document.getElementById('referral-banner').classList.remove('hidden');
            document.querySelectorAll('.plan-card').forEach(card => {
                const planData = JSON.parse(card.dataset.plan);
                const newSlots = planData.slots + 1;
                card.querySelector('.plan-slots').innerHTML = `${planData.slots} + <span class="text-green-500">1</span>`;
                card.dataset.plan = JSON.stringify({...planData, slots: newSlots});
            });
            selectedPlan = JSON.parse(document.getElementById('recommended-plan').dataset.plan);
        }

        if (paymentStatus === 'success') {
            showModal('modal-success');
            window.history.replaceState({}, document.title, "/");
        }

        // --- FUNCIÓN DE PAGO ---
        async function createCheckoutPreference(firstName, lastName) {
            confirmAndPayBtn.firstElementChild.textContent = 'Procesando...';
            confirmAndPayBtn.disabled = true;

            try {
                const response = await fetch("/create_preference", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        title: `${selectedPlan.name} (${selectedPlan.slots} slots)`,
                        price: selectedPlan.price,
                        payer_firstname: firstName,
                        payer_lastname: lastName,
                        contacts_to_protect: contacts,
                        referral_code: referralCode
                    }),
                });
                if (!response.ok) throw new Error((await response.json()).error || 'Error del servidor');
                const preference = await response.json();
                if (preference.init_point) {
                    window.location.href = preference.init_point;
                } else {
                    throw new Error('No se recibió la URL de pago');
                }
            } catch (error) {
                console.error("Error al crear la preferencia de pago:", error);
                document.getElementById('payment-error').textContent = 'Hubo un error. Por favor, intenta de nuevo.';
                confirmAndPayBtn.disabled = false;
                confirmAndPayBtn.firstElementChild.textContent = 'Pagar y Proteger';
            }
        }
        
        // ✅ IA-UPDATE: SE RESTAURA TODA LA LÓGICA DEL FUNNEL Y EVENTOS
        
        // --- SELECTORES COMPLETOS ---
        const mainContent = document.getElementById('main-content');
        const heroSection = document.getElementById('hero-section');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const progressBar = document.getElementById('progress-bar');
        const plansSection = document.getElementById('plans-section');
        const contactsSection = document.getElementById('contacts-section');
        const paymentSection = document.getElementById('payment-section');
        const slotCounter = document.getElementById('slot-counter');
        const contactsSubtitle = document.getElementById('contacts-subtitle');
        const contactInput = document.getElementById('contact-input');
        const addContactBtn = document.getElementById('add-contact-btn');
        const contactList = document.getElementById('contact-list');
        const continueToPaymentBtn = document.getElementById('continue-to-payment-btn');
        const backToPlansBtn = document.getElementById('back-to-plans-btn');
        const backToContactsBtn = document.getElementById('back-to-contacts-btn');
        const summaryPlanName = document.getElementById('summary-plan-name');
        const summaryContactCount = document.getElementById('summary-contact-count');
        const summaryTotalPrice = document.getElementById('summary-total-price');
        const logoLink = document.getElementById('logo-link');
        const allPlanLinks = document.querySelectorAll('a[href="#plans-section"]');
        const payerFirstname = document.getElementById('payer-firstname');
        const payerLastname = document.getElementById('payer-lastname');
        const termsCheckbox = document.getElementById('terms-checkbox');

        // --- MANEJO DEL FUNNEL ---
        function showStep(stepNumber) {
            currentStep = stepNumber;
            if (stepNumber > 0) {
                progressBarContainer.classList.remove('opacity-0', '-translate-y-4');
            } else {
                progressBarContainer.classList.add('opacity-0', '-translate-y-4');
            }
            if (stepNumber >= 1) { 
                heroSection.classList.add('hidden');
            } else {
                heroSection.classList.remove('hidden');
            }
            [plansSection, contactsSection, paymentSection].forEach(s => s.classList.add('hidden'));
            
            let sectionToShow;
            if (stepNumber === 1) {
                sectionToShow = plansSection;
                updateProgressBar(33);
            } else if (stepNumber === 2) {
                sectionToShow = contactsSection;
                updateProgressBar(66);
                updateContactUI();
            } else if (stepNumber === 3) {
                sectionToShow = paymentSection;
                updateProgressBar(100);
                updateSummary();
            }
            if(sectionToShow){
                sectionToShow.classList.remove('hidden');
                sectionToShow.classList.add('fade-in');
                sectionToShow.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        function updateProgressBar(percentage) { progressBar.style.width = `${percentage}%`; }

        // --- EVENT LISTENERS ---
        allPlanLinks.forEach(anchor => anchor.addEventListener('click', e => { e.preventDefault(); showStep(1); }));
        logoLink.addEventListener('click', e => { e.preventDefault(); if(currentStep > 0) { showStep(0); window.scrollTo({ top: 0, behavior: 'smooth' }); } else { location.reload(); } });
        plansContainer.addEventListener('click', e => {
            const card = e.target.closest('.plan-card');
            if (!card) return;
            selectedPlan = JSON.parse(card.dataset.plan);
            document.querySelectorAll('.plan-card').forEach(c => c.classList.remove('selected', 'border-blue-600'));
            card.classList.add('selected', 'border-blue-600');
            setTimeout(() => showStep(2), 200);
        });
        contactInput.addEventListener('input', () => { addContactBtn.disabled = contactInput.value.trim() === '' || contacts.length >= selectedPlan.slots; });
        addContactBtn.addEventListener('click', () => {
            if (contactInput.value.trim() && contacts.length < selectedPlan.slots) {
                contacts.push(contactInput.value.trim());
                contactInput.value = '';
                renderContacts();
            }
        });
        contactList.addEventListener('click', e => {
            if (e.target.closest('.delete-contact-btn')) {
                contacts = contacts.filter(c => c !== e.target.closest('.delete-contact-btn').dataset.contact);
                renderContacts();
            }
        });
        continueToPaymentBtn.addEventListener('click', () => { if (contacts.length > 0) showStep(3); });
        backToPlansBtn.addEventListener('click', () => showStep(1));
        backToContactsBtn.addEventListener('click', () => showStep(2));

        function validatePayerForm() {
            confirmAndPayBtn.disabled = !(payerFirstname.value.trim() && payerLastname.value.trim() && termsCheckbox.checked);
        }
        payerFirstname.addEventListener('input', validatePayerForm);
        payerLastname.addEventListener('input', validatePayerForm);
        termsCheckbox.addEventListener('change', validatePayerForm);
        confirmAndPayBtn.addEventListener('click', () => {
            createCheckoutPreference(payerFirstname.value.trim(), payerLastname.value.trim());
        });

        // --- RENDERIZADO Y UI ---
        function updateContactUI() {
            slotCounter.textContent = `${contacts.length} / ${selectedPlan.slots}`;
            contactsSubtitle.textContent = `Tienes ${selectedPlan.slots} slots para elegir entre teléfonos y correos.`;
            contactInput.disabled = contacts.length >= selectedPlan.slots;
            addContactBtn.disabled = contactInput.value.trim() === '' || contacts.length >= selectedPlan.slots;
            continueToPaymentBtn.disabled = contacts.length === 0;
        }
        function renderContacts() {
            contactList.innerHTML = '';
            contacts.forEach(contact => {
                const item = document.createElement('div');
                item.className = 'flex items-center justify-between bg-white/60 p-3 rounded-lg animate-scale-in';
                item.innerHTML = `<span class="text-gray-800 font-medium">${contact}</span><button data-contact="${contact}" class="delete-contact-btn text-red-500 hover:text-red-700 p-2 rounded-full"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>`;
                contactList.appendChild(item);
            });
            updateContactUI();
        }
        function updateSummary() {
            summaryPlanName.textContent = selectedPlan.name;
            summaryContactCount.textContent = contacts.length;
            summaryTotalPrice.textContent = `$${selectedPlan.price.toLocaleString('es-CL')}`;
        }
        
        // --- MODALES ---
        window.showModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.replace('hidden', 'flex');
        };
        window.closeModal = (modalId) => {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.replace('flex', 'hidden');
            if (modalId === 'modal-success') location.href = '/';
        };
    });
    </script>
</body>
</html>
